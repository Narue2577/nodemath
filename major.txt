// 1. Install dependencies:
// npm install nodemailer @types/nodemailer
// npm install jsonwebtoken @types/jsonwebtoken

// 2. Create API route: app/api/send-permission/route.ts
import { NextRequest, NextResponse } from 'next/server';
import nodemailer from 'nodemailer';
import jwt from 'jsonwebtoken';

const JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key';
const BASE_URL = process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000';

export async function POST(request: NextRequest) {
  try {
    const { email, permission, expiresIn = '7d' } = await request.json();

    // Generate a secure token with permission details
    const token = jwt.sign(
      { email, permission, timestamp: Date.now() },
      JWT_SECRET,
      { expiresIn }
    );

    // Create confirmation link
    const confirmLink = `${BASE_URL}/confirm-permission?token=${token}`;

    // Configure email transporter (using Gmail as example)
    const transporter = nodemailer.createTransport({
      service: 'gmail',
      auth: {
        user: process.env.EMAIL_USER,
        pass: process.env.EMAIL_PASSWORD, // Use App Password for Gmail
      },
    });

    // Email content
    const mailOptions = {
      from: process.env.EMAIL_USER,
      to: email,
      subject: 'Permission Request Confirmation',
      html: `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
          <h2>Permission Request</h2>
          <p>You have been requested to grant the following permission:</p>
          <p style="background: #f5f5f5; padding: 15px; border-radius: 5px;">
            <strong>${permission}</strong>
          </p>
          <p>Click the button below to confirm your permission:</p>
          <a href="${confirmLink}" 
             style="display: inline-block; background: #0070f3; color: white; 
                    padding: 12px 24px; text-decoration: none; border-radius: 5px; 
                    margin: 20px 0;">
            Confirm Permission
          </a>
          <p style="color: #666; font-size: 14px;">
            This link will expire in 7 days.
          </p>
          <p style="color: #666; font-size: 14px;">
            If you didn't expect this email, you can safely ignore it.
          </p>
        </div>
      `,
    };

    await transporter.sendMail(mailOptions);

    return NextResponse.json({ 
      success: true, 
      message: 'Permission email sent successfully' 
    });
  } catch (error) {
    console.error('Error sending email:', error);
    return NextResponse.json(
      { success: false, error: 'Failed to send email' },
      { status: 500 }
    );
  }
}

// 3. Create confirmation page: app/confirm-permission/page.tsx
'use client';

import { useEffect, useState } from 'react';
import { useSearchParams } from 'next/navigation';

export default function ConfirmPermission() {
  const searchParams = useSearchParams();
  const [status, setStatus] = useState<'loading' | 'success' | 'error'>('loading');
  const [message, setMessage] = useState('');

  useEffect(() => {
    const token = searchParams.get('token');
    if (!token) {
      setStatus('error');
      setMessage('Invalid confirmation link');
      return;
    }

    confirmPermission(token);
  }, [searchParams]);

  const confirmPermission = async (token: string) => {
    try {
      const response = await fetch('/api/confirm-permission', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token }),
      });

      const data = await response.json();

      if (data.success) {
        setStatus('success');
        setMessage('Permission confirmed successfully!');
      } else {
        setStatus('error');
        setMessage(data.error || 'Failed to confirm permission');
      }
    } catch (error) {
      setStatus('error');
      setMessage('An error occurred. Please try again.');
    }
  };

  return (
    <div style={{ 
      maxWidth: '600px', 
      margin: '50px auto', 
      padding: '20px',
      textAlign: 'center' 
    }}>
      {status === 'loading' && <p>Confirming your permission...</p>}
      {status === 'success' && (
        <div style={{ color: 'green' }}>
          <h2>✓ Success</h2>
          <p>{message}</p>
        </div>
      )}
      {status === 'error' && (
        <div style={{ color: 'red' }}>
          <h2>✗ Error</h2>
          <p>{message}</p>
        </div>
      )}
    </div>
  );
}

// 4. Create confirmation API: app/api/confirm-permission/route.ts
import { NextRequest, NextResponse } from 'next/server';
import jwt from 'jsonwebtoken';

const JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key';

export async function POST(request: NextRequest) {
  try {
    const { token } = await request.json();

    // Verify token
    const decoded = jwt.verify(token, JWT_SECRET) as {
      email: string;
      permission: string;
      timestamp: number;
    };

    // Store permission in your database
    // await db.permissions.create({
    //   email: decoded.email,
    //   permission: decoded.permission,
    //   confirmedAt: new Date(),
    // });

    return NextResponse.json({
      success: true,
      data: {
        email: decoded.email,
        permission: decoded.permission,
      },
    });
  } catch (error) {
    if (error instanceof jwt.TokenExpiredError) {
      return NextResponse.json(
        { success: false, error: 'Link has expired' },
        { status: 400 }
      );
    }
    return NextResponse.json(
      { success: false, error: 'Invalid or expired token' },
      { status: 400 }
    );
  }
}

// 5. Example usage in a component:
// app/components/PermissionForm.tsx
'use client';

import { useState } from 'react';

export default function PermissionForm() {
  const [email, setEmail] = useState('');
  const [permission, setPermission] = useState('');
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState('');

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setMessage('');

    try {
      const response = await fetch('/api/send-permission', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, permission }),
      });

      const data = await response.json();

      if (data.success) {
        setMessage('Permission email sent successfully!');
        setEmail('');
        setPermission('');
      } else {
        setMessage('Failed to send email. Please try again.');
      }
    } catch (error) {
      setMessage('An error occurred. Please try again.');
    } finally {
      setLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} style={{ maxWidth: '400px', margin: '0 auto' }}>
      <div style={{ marginBottom: '15px' }}>
        <label>Email:</label>
        <input
          type="email"
          value={email}
          onChange={(e) => setEmail(e.target.value)}
          required
          style={{ width: '100%', padding: '8px' }}
        />
      </div>
      <div style={{ marginBottom: '15px' }}>
        <label>Permission:</label>
        <input
          type="text"
          value={permission}
          onChange={(e) => setPermission(e.target.value)}
          required
          style={{ width: '100%', padding: '8px' }}
        />
      </div>
      <button 
        type="submit" 
        disabled={loading}
        style={{ width: '100%', padding: '10px' }}
      >
        {loading ? 'Sending...' : 'Send Permission Request'}
      </button>
      {message && <p style={{ marginTop: '15px' }}>{message}</p>}
    </form>
  );
}

// 6. Environment variables (.env.local):
// JWT_SECRET=your-super-secret-jwt-key-change-this
// EMAIL_USER=your-email@gmail.com
// EMAIL_PASSWORD=your-app-password
// NEXT_PUBLIC_BASE_URL=http://localhost:3000